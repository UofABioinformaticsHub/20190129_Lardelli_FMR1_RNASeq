---
title: "FMR1 Knockout"
subtitle: "RNA-Seq Analysis"
author: "Melanie Hand & Steve Pederson"
date: "19/07/2019"
output: 
  html_document: 
    toc: yes
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r packages}
library(limma)
library(edgeR)
library(AnnotationHub)
library(tidyverse)
library(magrittr)
library(pander)
library(RColorBrewer)
library(ggrepel)
library(scales)
library(here)
theme_set(theme_bw())
panderOptions("big.mark", ",")
panderOptions("table.split.table", Inf)
panderOptions("table.style", "rmarkdown")
if (interactive()) setwd(file.path(here(), "R"))
```

Annotation was set up as a EnsDb object based on Ensembl Release 94

```{r ensDb, cache=TRUE}
ah <- AnnotationHub() %>%
  subset(species == "Danio rerio") %>%
  subset(dataprovider == "Ensembl") %>%
  subset(rdataclass == "EnsDb")
ensDb <- AnnotationHub()[["AH64906"]]
genes <- genes(ensDb)
```

Prior to count-level analysis, the initial dataset was pre-processed using the following steps:

- Adapters were removed from any reads derived from RNA fragments < 300bp
- Bases were removed from the end of reads when the quality score dipped below 20
- Reads < 35bp after trimming were discarded

After trimming alignment was performed using STAR v2.5.3a to the *Danio rerio* genome included in Ensembl Release 94 (GRCz11).
Aligned reads were counted for each gene if the following criteria were satisfied:

- Alignments were unique
- Alignments strictly overlapped exonic regions

Counts were then loaded and set up as a DGEList.
During loading genes were only retained if receiving more than one counted alignment in at least 4 samples.


```{r x}
x <- file.path("../2_alignedData/featureCounts/genes.out") %>%
	read_tsv() %>%
	as.data.frame() %>%
	column_to_rownames("Geneid") %>%
	set_colnames(basename(colnames(.))) %>%
	set_colnames(str_remove(colnames(.), "_Aligned.+")) %>%
	magrittr::extract(rowSums(cpm(.) > 1) >= 4,) %>%
	DGEList(
		samples = tibble(
			sample = colnames(.),
			group = case_when(
                    sample %in% paste0("S", 1:8) ~ "FMR1",
                    !sample %in% paste0("S", 1:8)  ~ "Wildtype"
                  )) %>%
			mutate(group = factor(group, levels = c("Wildtype", "FMR1"))) %>%
			as.data.frame(),
		genes = genes[rownames(.)] %>%
			as.data.frame() %>%
			dplyr::select(
				ensembl_gene_id = gene_id,
				chromosome_name = seqnames,
				description, 
				external_gene_name = gene_name
			)
	) %>%
	calcNormFactors(method = "TMM") %>%
	estimateDisp()
```

This gave count information for `r nrow(x)` genes.
Library sizes after alignment, counting and gene filtering ranged between `r pander(comma(range(x$samples$lib.size)))` reads.

## Data Inspection

Data was subsequently configured for analysis using voom, in which the assumption of normality can be applied and sample weights can be incorporated.
Sample weights were calculated assuming all samples belong to the same treatment group to ensure conservative weights are assigned.

```{r v}
v <- x %>%
	voomWithQualityWeights(design = matrix(1, nrow = ncol(.)))
```

```{r plotWeights, echo=FALSE, fig.cap = "Sample weights with the ideal equal weight of 1 shown as a horizontal line."}
v$targets %>%
	ggplot(aes(sample, sample.weights, fill = group)) +
	geom_bar(stat = "identity") +
	geom_hline(yintercept = 1, colour = "blue", linetype = 2) +
	labs(fill = "Sample Group")
```


```{r pca}
pca <- v$E %>%
	t() %>%
	prcomp()
```

A PCA was performed using logCPM transformed counts after removal of undetectable genes.
Whilst some separation was observed, the location of sample S5 appeared less than satisfactory, and the spread between Wildtype samples also appeared to coincide with the largest source of variability in the data.

```{r plotPCA, echo=FALSE, fig.cap = "PCA of all samples. Point sizes indicate library sizes with the combination of PC1 & PC2 appearing to capture a considerable amount of this variation."}
pca$x %>%
	as.data.frame() %>%
	rownames_to_column("sample") %>%
	left_join(v$targets) %>%
	ggplot(aes(PC1, PC2, colour = group)) +
	geom_point(aes(size = lib.size/1e6)) +
	geom_text_repel(aes(label = sample), show.legend = FALSE) +
	labs(size = "Library Size\n(millions)",
		 colour = "Sample Group") +
	theme(legend.title.align = 0.5)
```

Finally, genotypes were checked using *fmr1* expression as a proxy.
Expression of *fmr1* appeared to track with genotype as expected and no sample mislabelling was identified.

```{r plotFMR1, echo=FALSE, fig.cap = "Expression of *fmr1* across all samples.", fig.show='asis'}
x %>%
	cpm(log = TRUE) %>%
	.["ENSDARG00000037433",] %>%
	as.matrix() %>%
	set_colnames("logCPM") %>%
	cbind(x$samples[rownames(.),]) %>%
	ggplot(aes(sample, logCPM, fill = group)) +
	geom_bar(stat = "identity")
```


## Analysis

### DGE Analysis

The `voom` methodology was applied for differential gene expression (DGE) analysis, incorporating sample weights as calculated earlier.
A simple two group design matrix was used.

```{r efit}
design <- model.matrix(~v$targets$group)
colnames(design) <- c("Wildtype", "FMR1vsWildtype")
efit <- v %>%
	lmFit(design) %>%
	eBayes()
```

```{r deGenes}
deGenes <- efit %>%
	topTable(coef = "FMR1vsWildtype", number = Inf, sort.by = "p") %>%
	as_tibble()
```

```{r volcano, echo=FALSE, fig.cap = "Volcano plot highlighting DE genes"}
deGenes %>%
	mutate(Sig = adj.P.Val < 0.05) %>%
	ggplot(aes(logFC, -log10(P.Value), colour = Sig)) +
	geom_point() +
	geom_text_repel(aes(label = external_gene_name), 
					data = . %>% dplyr::filter(Sig)) +
	geom_vline(xintercept = c(-1, 1), linetype = 2, colour = "grey50") +
	geom_hline(yintercept = deGenes %>%
			   	dplyr::filter(adj.P.Val < 0.05) %>%
			   	.[["P.Value"]] %>%
			   	max() %>% 
			   	log(10) %>%
			   	multiply_by(-1), 
			   linetype = 2, colour = "blue") +
	scale_colour_manual(values = c(rgb(0.5, 0.5, 0.5, 0.5), "red")) +
	scale_x_continuous(breaks = seq(-6, 6, by = 2)) +
	theme(legend.position = "none")
```

```{r plotMA, echo=FALSE, fig.cap="logFC plotted against expression level with significant DE genes shown in red."}
deGenes %>%
mutate(Sig = adj.P.Val < 0.05) %>%
	ggplot(aes(AveExpr, logFC, colour = Sig)) +
	geom_point() +
	geom_text_repel(aes(label = external_gene_name), 
					data = . %>% dplyr::filter(Sig | abs(logFC) > 4.5)) +
	geom_hline(yintercept = c(-1, 1), linetype = 2, colour = "grey50") +
	labs(
		x = "Average Expression (logCPM)",
		y = "logFC"
	) +
	scale_colour_manual(values = c(rgb(0.5, 0.5, 0.5, 0.5), "red")) +
	theme(legend.position = "none")
```

The `r sum(deGenes$adj.P.Val < 0.05)` genes considered as DE using an FDR of 0.05 were then inspected to confirm that the counts support their inclusion as DE.

```{r plotCPM, echo=FALSE, fig.cap="Expression values for eachof the DE genes using raw CPM values and a log-scale y-axis."}
x %>%
	cpm() %>%
	.[dplyr::filter(deGenes, adj.P.Val < 0.05)$ensembl_gene_id,] %>%
	as.data.frame() %>%
	rownames_to_column("ensembl_gene_id") %>%
	as_tibble() %>%
	gather(key = "sample", value = "CPM", -ensembl_gene_id) %>%
	left_join(x$samples) %>%
	left_join(x$genes) %>%
	ggplot(aes(group, CPM)) +
	geom_boxplot(aes(fill = group)) +
	geom_jitter(width = 0.1) +
	facet_wrap(~external_gene_name, scales = "free_y") +
	scale_y_log10() +
	theme(legend.position = "none")
```

```{r, echo=FALSE}
deGenes %>%
	dplyr::slice(1:10) %>%
	dplyr::select(-chromosome_name, -B) %>%
	mutate(description = gsub("([^\\[]*).+", "\\1", description)) %>%
	pander(
		justify = "lllrrrrr",
		caption = "Top 10 results from DGE analysis. Adjusted p-values represent the Benjamini-Hochberg FDR.")
```


The final results were exported as the file `FMR1vWildtype.csv`

```{r exportCSV}
write_csv(deGenes, "../results/FMR1vWildtype.csv")
```

### BLAST Analysis (FMR1)

For each of the 3 DE genes, a brief analysis was performed using the Ensembl BLAST server to search all cDNAs within the zebrafish transcriptome, with parameters set for distant homology. 
For each gene the longest transcript was chosen as the query sequence.
Only results with an E-value < 1 were retained.

```{r loadFMR1blast, echo=FALSE}
fmr1Blast <- read_csv(
	"../results/fmr1_blastn_results.csv",
	col_types = "cciicccciiccnnc"
) %>%
	mutate(Length = str_extract(Length, "[0-9]+") %>% as.integer())
```

```{r fmr1BlastTable, echo=FALSE}
fmr1Blast %>% 
	dplyr::filter(`Gene hit` != "fmr1") %>%
	group_by(`Gene hit`) %>%
	summarise(`Total Matches` = n(),
			  `Longest Match` = max(Length)) %>%
	arrange(desc(`Longest Match`), desc(`Total Matches`)) %>%
	left_join(as.data.frame(genes), by = c(`Gene hit` = "symbol")) %>%
	dplyr::select(`Gene hit`, description, `Total Matches`, `Longest Match`) %>%
	distinct(`Gene hit`, .keep_all = TRUE) %>%
	mutate(description = gsub("([^\\[]+).+", "\\1", description)) %>%
	pander(
		caption = "Summary of BLAST matches for *fmr1*",
		justify = "llrr"
	)
```

```{r volcanoFMR1, echo=FALSE, fig.cap="Volcano plot showing closest genes from the BLAST search on *fmr1*"}
deGenes %>%
	mutate(`Blast Hit` = external_gene_name %in% fmr1Blast$`Gene hit`) %>%
	arrange(`Blast Hit`) %>%
	ggplot(aes(logFC, -log10(P.Value), label = external_gene_name, colour = `Blast Hit`)) +
	geom_point(alpha = 0.4) +
	geom_text_repel(data = . %>% dplyr::filter(`Blast Hit`),
					show.legend = FALSE) +
	scale_colour_manual(values = c("grey50", "red"))
```

### BLAST Analysis (Other genes)

Although not the subject of investigation, the genes detected as DE were analysed using BLAST as a reverse viewpoint on the experiment.
Neither gene contained matches to *fmr1*.

```{r loadSMTNLBlaast, echo=FALSE}
smtnl1Blast <- read_csv(
	"../results/smtnl1_blastn_results.csv",
	col_types = "cciicccciiccnnc"
) %>%
	mutate(Length = str_extract(Length, "[0-9]+") %>% as.integer())
```

```{r smtnl1BlastTable, echo=FALSE}
smtnl1Blast %>% 
	dplyr::filter(`Gene hit` != "smtnl1") %>%
	group_by(`Gene hit`) %>%
	summarise(`Total Matches` = n(),
			  `Longest Match` = max(Length)) %>%
	arrange(desc(`Longest Match`), desc(`Total Matches`)) %>%
	left_join(as.data.frame(genes), by = c(`Gene hit` = "symbol")) %>%
	dplyr::select(`Gene hit`, description, `Total Matches`, `Longest Match`) %>%
	distinct(`Gene hit`, .keep_all = TRUE) %>%
	mutate(description = gsub("([^\\[]+).+", "\\1", description)) %>%
	pander(
		caption = "Summary of BLAST matches for *smtnl1*",
		justify = "llrr"
	)
```

```{r volcanoSMTNL1, echo=FALSE, fig.cap="Volcano plot showing closest genes from the BLAST search on *smtnl1*"}
deGenes %>%
	mutate(`Blast Hit` = external_gene_name %in% smtnl1Blast$`Gene hit`) %>%
	arrange(`Blast Hit`) %>%
	ggplot(aes(logFC, -log10(P.Value), label = external_gene_name, colour = `Blast Hit`)) +
	geom_point(alpha = 0.4) +
	geom_text_repel(data = . %>% dplyr::filter(`Blast Hit`),
					show.legend = FALSE) +
	scale_colour_manual(values = c("grey50", "red"))
```


```{r loadCU_Blast, echo=FALSE}
CU468164.1Blast <- read_csv(
	"../results/CU468164.1_blastn_results.csv",
	col_types = "cciiccciicnnc"
) %>%
	mutate(Length = str_extract(Length, "[0-9]+") %>% as.integer())
```

```{r CU_BlastTable, echo=FALSE}
CU468164.1Blast %>% 
	dplyr::filter(`Gene hit` != "CU468164.1") %>%
	group_by(`Gene hit`) %>%
	summarise(`Total Matches` = n(),
			  `Longest Match` = max(Length)) %>%
	arrange(desc(`Longest Match`), desc(`Total Matches`)) %>%
	left_join(as.data.frame(genes), by = c(`Gene hit` = "symbol")) %>%
	dplyr::select(`Gene hit`, description, `Total Matches`, `Longest Match`) %>%
	distinct(`Gene hit`, .keep_all = TRUE) %>%
	mutate(description = gsub("([^\\[]+).+", "\\1", description)) %>%
	pander(
		caption = "Summary of BLAST matches for *CU468164.1*",
		justify = "llrr"
	)
```

```{r volcanoCU_, echo=FALSE, fig.cap="Volcano plot showing closest genes from the BLAST search on *smtnl1*"}
deGenes %>%
	mutate(`Blast Hit` = external_gene_name %in% c("CU468164.1", CU468164.1Blast$`Gene hit`)) %>%
	arrange(`Blast Hit`) %>%
	ggplot(aes(logFC, -log10(P.Value), label = external_gene_name, colour = `Blast Hit`)) +
	geom_point(alpha = 0.4) +
	geom_text_repel(data = . %>% dplyr::filter(`Blast Hit`),
					show.legend = FALSE) +
	scale_colour_manual(values = c("grey50", "red"))
```

## Conclusion

At this stage, no clear evidence can be found for genetic compensation in this dataset.
Alternative strategies were briefly investigated using pair-wise alignments between all DE genes, but no compelling results were found.
As no specific evidence exists for 3'UTR, 5'UTR or other non-coding regions in compensation, so analysis was conducted on these elements.

# Session Info

```{r sessionInfo, echo=FALSE}
pander(sessionInfo())
```

